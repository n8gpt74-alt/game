# Требования: Сохранение игрового прогресса

## 1. Обзор

Игроки должны иметь возможность выйти из игры и вернуться позже, сохранив весь свой прогресс. Система должна корректно обрабатывать деградацию состояния питомца во время отсутствия игрока, но не терять прогресс по уровням, ресурсам и инвентарю.

## 2. Пользовательские истории

### 2.1 Базовое сохранение
**Как** игрок  
**Я хочу** чтобы мой прогресс автоматически сохранялся  
**Чтобы** не потерять достижения при выходе из игры

**Критерии приёмки:**
- Все действия игрока сохраняются на сервере немедленно
- Уровень, опыт, монеты, интеллект, кристаллы сохраняются
- Инвентарь и экипировка сохраняются
- История действий сохраняется (последние 30 событий)
- Прогресс ежедневных заданий сохраняется

### 2.2 Возврат в игру
**Как** игрок  
**Я хочу** вернуться к своему питомцу после перерыва  
**Чтобы** продолжить игру с того места, где остановился

**Критерии приёмки:**
- При входе загружается актуальное состояние с сервера
- Уровень, ресурсы и инвентарь остаются без изменений
- Состояние питомца (голод, энергия, чистота) деградирует реалистично
- Показывается время последней активности
- Если игрок отсутствовал >24 часов, питомец "скучает"

### 2.3 Офлайн-режим
**Как** игрок  
**Я хочу** играть даже при проблемах с сетью  
**Чтобы** не прерывать игровой процесс

**Критерии приёмки:**
- Локальный кэш сохраняет последнее состояние
- При офлайне игра работает с локальными данными
- При восстановлении сети данные синхронизируются
- Конфликты разрешаются в пользу серверных данных
- Игрок видит индикатор офлайн-режима

### 2.4 Защита от потери данных
**Как** игрок  
**Я хочу** быть уверенным, что мой прогресс не потеряется  
**Чтобы** не тратить время зря

**Критерии приёмки:**
- Транзакционное сохранение в БД (откат при ошибке)
- Автоматическое восстановление из кэша при сбое
- Логирование всех критических операций
- Резервное копирование состояния в localStorage
- Graceful degradation при ошибках

## 3. Функциональные требования

### 3.1 Серверное сохранение
- **FR-1.1**: Каждое действие игрока должно сохраняться в PostgreSQL
- **FR-1.2**: Использовать транзакции для атомарности операций
- **FR-1.3**: Сохранять timestamp последней активности (`last_active_at`)
- **FR-1.4**: Сохранять timestamp последнего тика деградации (`last_tick_at`)
- **FR-1.5**: Логировать все события в таблицу `event_logs`

### 3.2 Деградация состояния
- **FR-2.1**: Применять деградацию только при загрузке состояния
- **FR-2.2**: Ограничивать максимальную деградацию (cap: 6 часов)
- **FR-2.3**: Учитывать фактор одиночества (>24ч отсутствия)
- **FR-2.4**: Не деградировать уровень, опыт, ресурсы
- **FR-2.5**: Деградировать только: голод, энергию, чистоту, настроение, здоровье

### 3.3 Клиентский кэш
- **FR-3.1**: Сохранять снимок состояния в localStorage
- **FR-3.2**: Обновлять кэш при каждом изменении state
- **FR-3.3**: Загружать из кэша при старте (показывать сразу)
- **FR-3.4**: Синхронизировать с сервером в фоне
- **FR-3.5**: Хранить: state, history (30), daily, catalog, inventory

### 3.4 Синхронизация
- **FR-4.1**: Автоматическая синхронизация каждые 40 секунд
- **FR-4.2**: Синхронизация при восстановлении сети
- **FR-4.3**: Приоритет серверных данных при конфликтах
- **FR-4.4**: Показывать индикатор синхронизации
- **FR-4.5**: Обработка ошибок сети gracefully

## 4. Нефункциональные требования

### 4.1 Производительность
- **NFR-1.1**: Сохранение действия < 500ms
- **NFR-1.2**: Загрузка состояния < 1s
- **NFR-1.3**: Размер кэша < 1MB
- **NFR-1.4**: Оптимизация запросов к БД (индексы)

### 4.2 Надёжность
- **NFR-2.1**: Доступность сервера 99.9%
- **NFR-2.2**: Транзакционная целостность данных
- **NFR-2.3**: Автоматическое восстановление при сбоях
- **NFR-2.4**: Логирование ошибок

### 4.3 Безопасность
- **NFR-3.1**: JWT-авторизация для всех запросов
- **NFR-3.2**: Валидация данных на сервере
- **NFR-3.3**: Защита от читерства (серверная авторитетность)
- **NFR-3.4**: Шифрование чувствительных данных

### 4.4 Масштабируемость
- **NFR-4.1**: Поддержка 10,000+ одновременных игроков
- **NFR-4.2**: Горизонтальное масштабирование API
- **NFR-4.3**: Кэширование в Redis
- **NFR-4.4**: Оптимизация запросов к БД

## 5. Технические ограничения

### 5.1 Существующая архитектура
- Бэкенд: FastAPI + SQLAlchemy + PostgreSQL
- Фронтенд: React + TypeScript
- Кэш: Redis для Celery
- Деплой: Docker Compose

### 5.2 Совместимость
- Telegram Mini App API
- localStorage (5MB лимит)
- Мобильные браузеры (iOS Safari, Android Chrome)

### 5.3 Зависимости
- Существующие модели БД (PetState, EventLog, etc.)
- Система деградации (apply_time_decay)
- API endpoints (/state, /action/*, etc.)

## 6. Приоритеты

### Высокий приоритет (Must Have)
- Серверное сохранение всех действий
- Корректная деградация при возврате
- Базовый офлайн-кэш

### Средний приоритет (Should Have)
- Автоматическая синхронизация
- Индикаторы состояния сети
- Обработка конфликтов

### Низкий приоритет (Nice to Have)
- Расширенная аналитика
- Резервное копирование
- Миграция данных

## 7. Риски и митигация

### 7.1 Потеря данных
**Риск**: Сбой сервера во время сохранения  
**Митигация**: Транзакции БД, локальный кэш, логирование

### 7.2 Рассинхронизация
**Риск**: Конфликт между локальными и серверными данными  
**Митигация**: Приоритет сервера, timestamp-based resolution

### 7.3 Производительность
**Риск**: Медленное сохранение при высокой нагрузке  
**Митигация**: Индексы БД, кэширование, оптимизация запросов

### 7.4 Читерство
**Риск**: Манипуляция локальным кэшем  
**Митигация**: Серверная валидация, авторитетная симуляция

## 8. Метрики успеха

- **Сохранность данных**: 99.99% действий сохранены успешно
- **Время загрузки**: <1s для 95% запросов
- **Офлайн-работа**: 100% базовых действий доступны
- **Удовлетворённость**: 0 жалоб на потерю прогресса

## 9. Зависимости от других фич

- Система авторизации (JWT)
- Игровая механика (действия, награды)
- Система деградации (time decay)
- Ежедневные задания
- Магазин и инвентарь

## 10. Вопросы для уточнения

1. Нужно ли сохранять историю действий навсегда или с ограничением?
2. Как обрабатывать ситуацию, когда игрок не заходил несколько дней?
3. Нужна ли возможность "отката" к предыдущему состоянию?
4. Какой максимальный период офлайн-работы?
5. Нужны ли бэкапы состояния игрока?
